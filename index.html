<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>購物車 with Excel & Email</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    .product { border: 1px solid #ccc; padding: 10px; margin: 10px; display: inline-block; width: 200px; }
    .cart { margin-top: 20px; }
    button { margin-top: 10px; padding: 5px 10px; }
    input[type="email"] { padding: 5px; width: 250px; }
  </style>
</head>
<body>
  <h1>🛍️ 簡易購物車</h1>
  <div id="products"></div>

  <div class="cart">
    <h2>🛒 購物車</h2>
    <ul id="cart-items"></ul>
    <p><strong>總金額:</strong> $<span id="total">0.00</span></p>

    <button onclick="exportToExcel()">⬇️ 下載 Excel</button><br><br>

    <input type="email" id="user-email" placeholder="請輸入您的 Email"><br>
    <button onclick="sendEmail()">📧 寄送購物清單</button>
  </div>

  <script>
    emailjs.init("XMzj2U51edt0fLBjT"); // ✅ 替換成你的 EmailJS 使用者 ID

    const products = [
      { id: 1, name: "Apple", price: 1.5 },
      { id: 2, name: "Banana", price: 0.9 },
      { id: 3, name: "Chocolate", price: 2.0 }
    ];

    const cart = {};

    function renderProducts() {
      const container = document.getElementById("products");
      products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `<h3>${p.name}</h3><p>價格: $${p.price.toFixed(2)}</p><button onclick="addToCart(${p.id})">加入購物車</button>`;
        container.appendChild(div);
      });
    }

    function addToCart(id) {
      const product = products.find(p => p.id === id);
      if (cart[id]) {
        cart[id].quantity += 1;
      } else {
        cart[id] = { ...product, quantity: 1 };
      }
      renderCart();
    }

    function renderCart() {
      const ul = document.getElementById("cart-items");
      const total = document.getElementById("total");
      ul.innerHTML = "";
      let sum = 0;
      for (let id in cart) {
        const item = cart[id];
        const subtotal = item.price * item.quantity;
        const li = document.createElement("li");
        li.textContent = `${item.name} × ${item.quantity} = $${subtotal.toFixed(2)}`;
        ul.appendChild(li);
        sum += subtotal;
      }
      total.textContent = sum.toFixed(2);
    }

    function exportToExcel() {
      const data = [];
      let totalSum = 0;
      for (let id in cart) {
        const item = cart[id];
        const subtotal = item.price * item.quantity;
        totalSum += subtotal;
        data.push({
          商品名稱: item.name,
          數量: item.quantity,
          單價: item.price,
          小計: subtotal
        });
      }
      if (data.length === 0) {
        alert("購物車是空的！");
        return;
      }
      data.push({ 商品名稱: "總金額", 小計: totalSum });

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "購物清單");
      XLSX.writeFile(wb, "購物清單.xlsx");
    }

    function sendEmail() {
      const email = document.getElementById("user-email").value.trim();
      if (!email) return alert("請輸入 Email！");
      if (Object.keys(cart).length === 0) return alert("購物車是空的！");

      let message = '';
      let total = 0;

      for (let id in cart) {
        const item = cart[id];
        const subtotal = item.price * item.quantity;
        message += `${item.name} × ${item.quantity} = $${subtotal.toFixed(2)}\n`;
        total += subtotal;
      }
      message += `\n總金額：$${total.toFixed(2)}`;

      const templateParams = {
        user_email: email,
        message: message
      };
      emailjs.send("service_xxax3js","template_bv65a8p", templateParams)
        .then(res => alert("Email 已寄出！"), err => alert("寄送失敗：" + JSON.stringify(err)));
    }

    renderProducts();
  </script>
</body>
</html>
