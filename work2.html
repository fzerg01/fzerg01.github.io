<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç°¡æ˜“å•†å“ç®¡ç†</title>

  <!-- å¼•å…¥ Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- å¼•å…¥å…¶ä»– JS åº« -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .product {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px;
      display: inline-block;
      width: 100%;
    }
    button {
      margin-top: 10px;
      padding: 5px 10px;
    }
    input[type="file"] {
      padding: 5px;
      margin-top: 10px;
    }
    .cart {
      margin-top: 40px;
    }
    .cart ul {
      list-style: none;
      padding-left: 0;
    }
    .cart ul li {
      padding: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center">ğŸ“¦ å•†å“ç®¡ç†ç³»çµ±</h1>
    
    <!-- ä¸Šå‚³ Excel æª”æ¡ˆå€å¡Š -->
    <div class="row">
      <div class="col-12">
        <h2>ğŸ“¤ ä¸Šå‚³å•†å“ Excel</h2>
        <input type="file" id="excel-file" accept=".xlsx, .xls">
        <button onclick="loadExcel('file')" class="btn btn-primary">ä¸Šå‚³æ–°å•†å“</button>
      </div>
    </div>
<picture>
            <source srcset="images/apple_banana_chocolate_large.jpg" media="(min-width: 768px)">
            <source srcset="images/apple_banana_chocolate_medium.jpg" media="(min-width: 480px)">
            <img src="images/apple_banana_chocolate_small.jpg" alt="è˜‹æœé¦™è•‰å·§å…‹åŠ›">
        </picture>
    <!-- å•†å“å±•ç¤ºå€ -->
    <div id="products" class="row">
      <!-- å•†å“æœƒå‹•æ…‹ç”Ÿæˆåœ¨é€™è£¡ -->
    </div>

    <!-- è³¼ç‰©è»Šå€ -->
    <div class="cart">
      <h2>ğŸ›’ è³¼ç‰©è»Š</h2>
      <ul id="cart-items"></ul>
      <p><strong>ç¸½é‡‘é¡:</strong> $<span id="total">0.00</span></p>
      <button onclick="exportToExcel()" class="btn btn-success">â¬‡ï¸ ä¸‹è¼‰ Excel</button><br><br>

      <input type="email" id="user-email" class="form-control" placeholder="è«‹è¼¸å…¥æ‚¨çš„ Email"><br>
      <button onclick="sendEmail()" class="btn btn-info">ğŸ“§ å¯„é€è³¼ç‰©æ¸…å–®</button>
    </div>
  </div>

  <script>
    emailjs.init("XMzj2U51edt0fLBjT"); // æ›¿æ›ç‚ºä½ çš„ EmailJS ä½¿ç”¨è€… ID
    const cart = {};
    
    // è§£æ Excel è³‡æ–™çš„å…±ç”¨é‚è¼¯
    function parseExcelData(json) {
      return json.map((row, index) => ({
        id: index + 1,
        name: row["å•†å“åç¨±"],
        price: parseFloat(row["å–®åƒ¹"])
      }));
    }

    // è®€å–æœ¬åœ°æˆ–é ç«¯çš„ Excel æª”æ¡ˆ
    function loadExcel(type) {
      const handleFile = (data) => {
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        products = parseExcelData(json);
        renderProducts(products);
      };

      if (type === 'file') {
        const fileInput = document.getElementById('excel-file');
        const file = fileInput.files[0];
        if (!file) return alert("è«‹é¸æ“‡ä¸€å€‹ Excel æª”æ¡ˆ");

        const reader = new FileReader();
        reader.onload = (e) => handleFile(new Uint8Array(e.target.result));
        reader.readAsArrayBuffer(file);
      } else if (type === 'url') {
        fetch('https://fzerg01.github.io/assets/database.xlsx')
          .then(response => response.arrayBuffer())
          .then(handleFile)
          .catch(console.error);
      }
    }

    function renderProducts(products) {
      const container = document.getElementById("products");
      container.innerHTML = "";
      if (products.length === 0) {
        container.innerHTML = "<p>ç›®å‰ç„¡å•†å“è³‡æ–™ï¼Œè«‹ä¸Šå‚³ Excelã€‚</p>";
        return;
      }

      products.forEach(p => {
        const div = document.createElement("div");
        div.className = "product col-12 col-sm-6 col-md-4 col-lg-3";
        div.innerHTML = `
          <h3>${p.name}</h3>
          <p>åƒ¹æ ¼: $${p.price.toFixed(2)}</p>
          <button onclick="addToCart(${p.id})" class="btn btn-primary">åŠ å…¥è³¼ç‰©è»Š</button>
        `;
        container.appendChild(div);
      });
    }

    function addToCart(id) {
      const product = products.find(p => p.id === id);
      if (cart[id]) {
        cart[id].quantity += 1;
      } else {
        cart[id] = { ...product, quantity: 1 };
      }
      renderCart();
    }

    function renderCart() {
      const ul = document.getElementById("cart-items");
      const total = document.getElementById("total");
      ul.innerHTML = "";
      let sum = 0;
      for (let id in cart) {
        const item = cart[id];
        const subtotal = item.price * item.quantity;
        const li = document.createElement("li");
        li.textContent = `${item.name} Ã— ${item.quantity} = $${subtotal.toFixed(2)}`;
        ul.appendChild(li);
        sum += subtotal;
      }
      total.textContent = sum.toFixed(2);
    }

    function exportToExcel() {
      const data = [];
      let totalSum = 0;
      for (let id in cart) {
        const item = cart[id];
        const subtotal = item.price * item.quantity;
        totalSum += subtotal;
        data.push({
          å•†å“åç¨±: item.name,
          æ•¸é‡: item.quantity,
          å–®åƒ¹: item.price,
          å°è¨ˆ: subtotal
        });
      }
      if (data.length === 0) {
        alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼");
        return;
      }
      data.push({ å•†å“åç¨±: "ç¸½é‡‘é¡", å°è¨ˆ: totalSum });

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "è³¼ç‰©æ¸…å–®");
      XLSX.writeFile(wb, "è³¼ç‰©æ¸…å–®.xlsx");
    }

    function sendEmail() {
      const email = document.getElementById("user-email").value.trim();
      if (!email) return alert("è«‹è¼¸å…¥ Emailï¼");
      if (Object.keys(cart).length === 0) return alert("è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼");

      let message = '';
      let total = 0;

      for (let id in cart) {
        const item = cart[id];
        const subtotal = item.price * item.quantity;
        message += `${item.name} Ã— ${item.quantity} = $${subtotal.toFixed(2)}\n`;
        total += subtotal;
      }
      message += `\nç¸½é‡‘é¡ï¼š$${total.toFixed(2)}`;

      const templateParams = {
        user_email: email,
        message: message
      };
      emailjs.send("service_xxax3js", "template_bv65a8p", templateParams)
        .then(res => alert("Email å·²å¯„å‡ºï¼"), err => alert("å¯„é€å¤±æ•—ï¼š" + JSON.stringify(err)));
    }

    // åœ¨é é¢è¼‰å…¥æ™‚è‡ªå‹•è®€å–æª”æ¡ˆ
    window.onload = function() {
      loadExcel('url');  // é€™è£¡è¨­å®šæˆ 'url' å¯ä»¥å¾é ç«¯æª”æ¡ˆè¼‰å…¥
    };
  </script>

  <!-- å¼•å…¥ Bootstrap JS å’Œå…¶ä»–éœ€è¦çš„ JS åº« -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
